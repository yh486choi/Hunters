<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>오더 작성</title>

  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="order_write.css" />
</head>

<body>
  <div style='margin-top:10px; display:flex; gap:10px;'>
    <button class='buttonStyles' onclick="location.href='index.html'">홈 화면</button>
  </div>

  <h1>오더 작성</h1>

  <div style='margin-top:10px;'>
    <label>오더명: </label>
    <input type='text' id='orderName' placeholder='ex) 26-03-01 NBL' style='width:260px; padding:6px;' />
    <button class='buttonStyles' onclick='saveOrder()'>저장</button>
  </div>

  <div id='mainArea'>

    <!-- 참가 명단 -->
    <div id='areaA' class='panelBox'>
      <label style="font-weight: bolder;">참가 명단</label>

      <div style='display:flex; gap:10px; align-items:center; margin-bottom:10px;'>
        <select id='playerSelect'></select>
        <button class='buttonStyles' onclick='addPlayer()'>추가</button>
      </div>

      <table class="table_common">
        <thead>
          <tr>
            <th style="width: 80px;">선수명</th>
            <th style="width: 40px;">삭제</th>
          </tr>
        </thead>
        <tbody id='playerTableBody'></tbody>
      </table>
    </div>

    <!-- 중앙 필드 + 선발 -->
    <div id='positionWrapper'>

      <div id='areaB1'>
        <select id='pos_CF' class='posSelect' onchange='updatePosition("CF", this.value)'></select>
        <select id='pos_LF' class='posSelect' onchange='updatePosition("LF", this.value)'></select>
        <select id='pos_RF' class='posSelect' onchange='updatePosition("RF", this.value)'></select>

        <select id='pos_SS' class='posSelect' onchange='updatePosition("SS", this.value)'></select>
        <select id='pos_2B' class='posSelect' onchange='updatePosition("2B", this.value)'></select>
        <select id='pos_3B' class='posSelect' onchange='updatePosition("3B", this.value)'></select>
        <select id='pos_1B' class='posSelect' onchange='updatePosition("1B", this.value)'></select>

        <select id='pos_P' class='posSelect' onchange='updatePosition("P", this.value)'></select>
        <select id='pos_C' class='posSelect' onchange='updatePosition("C", this.value)'></select>
        <select id='pos_DH' class='posSelect' onchange='updatePosition("DH", this.value)'></select>
      </div>

      <div id='middleWrapper'>

        <div id='areaC1'>
          <table class="table_common">
            <caption style='font-weight:bolder;'>선발 명단</caption>
            <thead>
              <tr>
                <th style="width: 40px;">타순</th>
                <th style="width: 80px;">선수명</th>
                <th style="width: 100px;">포지션</th>
              </tr>
            </thead>
            <tbody id='startingTableBody'></tbody>
          </table>
        </div>

        <div id='areaC2'>
          <table class="table_common">
            <caption style='font-weight:bolder;'>대기 명단</caption>
            <thead>
              <tr>
                <th style="width: 80px;">선수명</th>
              </tr>
            </thead>
            <tbody id='waitingTableBody'></tbody>
          </table>
        </div>

      </div>

    </div>

    <!-- 출전 가능 포지션 -->
    <div id='areaB2'>
      <div id='positionAbilityContainer'></div>
    </div>

  </div>

  <!-- =======================
       JS 통합본 시작
  ======================= -->
  <script>
    const API = { getPlayers: 'https://getplayers-2guymqucma-uc.a.run.app' };

    let playerDB = [];
    let selectedPlayers = [];

    let positionAssignments = {
      CF: '', LF: '', RF: '',
      SS: '', '2B': '', '3B': '',
      P: '', C: '', DH: '', '1B': ''
    };

    let startingList = Array(10).fill().map(() => ({ name: '', pos: '' }));


    const abilityPositions = [
      { key: 'p', label: '투수' },
      { key: 'c', label: '포수' },
      { key: '1b', label: '1루' },
      { key: '2b', label: '2루' },
      { key: '3b', label: '3루' },
      { key: 'ss', label: '유격' },
      { key: 'of', label: '외야' }
    ];

    async function loadPlayerDB() {
      const res = await fetch(API.getPlayers);
      playerDB = await res.json();
    }

    function nameWithNum(name) {
      if (!name) return '';
      const p = playerDB.find(x => x.name === name);
      return p ? `${name}(${p.num})` : name;
    }

    /* ===============================
       참가 명단 처리
    =============================== */

    function renderPlayerSelect() {
      const select = document.getElementById('playerSelect');
      select.innerHTML = '';

      const candidates = playerDB.filter(p => !selectedPlayers.includes(p.name));

      if (candidates.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '추가 없음';
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      candidates.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = `${p.name}(${p.num})`;
        select.appendChild(opt);
      });
    }

    function renderPlayerTable() {
      const tbody = document.getElementById('playerTableBody');
      tbody.innerHTML = '';

      selectedPlayers
        .slice()
        .sort((a, b) => a.localeCompare(b, 'ko'))
        .forEach(name => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${nameWithNum(name)}</td>
            <td><button class='buttonStyles' onclick='removePlayer("${name}")'>삭제</button></td>
          `;
          tbody.appendChild(tr);
        });
    }

    function addPlayer() {
      const name = document.getElementById('playerSelect').value;
      if (!name) return;

      if (!selectedPlayers.includes(name)) {
        selectedPlayers.push(name);
      }

      refreshAll();
    }

    function removePlayer(name) {
      selectedPlayers = selectedPlayers.filter(n => n !== name);

      for (const key in positionAssignments) {
        if (positionAssignments[key] === name) {
          positionAssignments[key] = '';
        }
      }

      startingList = startingList.map(r =>
        r.name === name ? { name: '', num: '', pos: '' } : r
      );

      refreshAll();
    }

    /* ===============================
       필드 포지션 select
    =============================== */

    function renderPositionSelects() {
      const selects = document.querySelectorAll('.posSelect');

      selects.forEach(sel => {
        const pos = sel.id.replace('pos_', '');
        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        selectedPlayers.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = `${name}(${p.num})`;

          const assignedPos = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);

          if (assignedPos && assignedPos !== pos) {
            opt.style.background = '#d0d0d0';
            opt.style.color = '#555';
          }

          if (positionAssignments[pos] === name) opt.selected = true;

          sel.appendChild(opt);
        });
      });
    }

    function updatePosition(pos, name) {
      for (const key in positionAssignments) {
        if (key !== pos && positionAssignments[key] === name) {
          positionAssignments[key] = '';
        }
      }

      positionAssignments[pos] = name;

      refreshAll();
    }

    /* ===============================
       선발 테이블
    =============================== */

    function setupStartingTable() {
      const tbody = document.getElementById('startingTableBody');
      tbody.innerHTML = '';

      for (let i = 0; i < 10; i++) {
        const label = i === 9 ? '투수' : (i + 1);
        const tr = document.createElement('tr');

        if (i === 9) {
          tr.innerHTML = `
            <td>${label}</td>
            <td><span id='start_name_${i}'></span></td>
            <td id='start_pos_${i}'></td>
          `;
        } else {
          tr.innerHTML = `
            <td>${label}</td>
            <td><select id='start_sel_${i}' onchange='selectStarting(${i}, this.value)'></select></td>
            <td id='start_pos_${i}'></td>
          `;
        }

        tbody.appendChild(tr);
      }
    }

    function renderStartingTable() {
      const assignedPlayers = Object.values(positionAssignments).filter(Boolean);

      for (let i = 0; i < 10; i++) {
        if (i === 9) {
          const pitcher = positionAssignments['P'];
          const span = document.getElementById('start_name_9');
          const tdPos = document.getElementById('start_pos_9');

          if (pitcher) {
            const p = playerDB.find(x => x.name === pitcher);
            startingList[9] = {
              name: pitcher,
              num: p.num,
              pos: convertPosition('P')
            };
            span.textContent = nameWithNum(pitcher);
            tdPos.textContent = convertPosition('P');
          } else {
            startingList[9] = { name: '', num: '', pos: '' };
            span.textContent = '';
            tdPos.textContent = '';
          }
          continue;
        }

        const sel = document.getElementById(`start_sel_${i}`);
        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        assignedPlayers.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const opt = document.createElement('option');

          opt.value = name;
          opt.textContent = `${name}(${p.num})`;

          const alreadyUsed = startingList.slice(0, 9).some(r => r.name === name);

          if (alreadyUsed && startingList[i].name !== name) {
            opt.style.background = '#d0d0d0';
            opt.style.color = '#555';
          }

          if (startingList[i].name === name) opt.selected = true;

          sel.appendChild(opt);
        });

        const row = startingList[i];
        document.getElementById(`start_pos_${i}`).textContent = row.pos || '';
      }
    }

    function selectStarting(idx, name) {
      startingList.forEach((r, i) => {
        if (i !== idx && r.name === name) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      if (!name) {
        startingList[idx] = { name: '', num: '', pos: '' };
      } else {
        const p = playerDB.find(x => x.name === name);
        const foundPos = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);

        startingList[idx] = {
          name,
          num: p.num,
          pos: convertPosition(foundPos)
        };
      }

      refreshAll();
    }

    /* ===============================
       대기 명단
    =============================== */

function renderWaitingTable() {
  const tbody = document.getElementById('waitingTableBody');
  tbody.innerHTML = '';

  const used = startingList.map(r => r.name).filter(Boolean);

  selectedPlayers
    .filter(n => !used.includes(n)) // 선발 제외 → 대기 명단
    .sort((a, b) => a.localeCompare(b, 'ko'))
    .forEach(name => {

      const assignedPos = Object.keys(positionAssignments)
        .find(k => positionAssignments[k] === name);

      const isStarter = startingList.some(r => r.name === name);

      const tr = document.createElement('tr');

      // ⭐ 포지션은 선택되었는데 선발에는 포함되지 않은 경우 → 노란색 음영 (position-selected)
      if (assignedPos && !isStarter) {
        tr.classList.add("position-selected");  // ← 노란색 처리
      }

      tr.innerHTML = `<td>${nameWithNum(name)}</td>`;
      tbody.appendChild(tr);
    });
}


    /* ===============================
       능력표 (음영 처리 복구)
    =============================== */

    function renderPositionAbility() {
      const container = document.getElementById('positionAbilityContainer');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.classList.add("table_common");

      const players = [...selectedPlayers].sort((a, b) => a.localeCompare(b, 'ko'));

      abilityPositions.forEach(pos => {
        const starters = [];
        const backups = [];

        players.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const val = Number(p[pos.key]);
          if (val === 2) starters.push(name);
          else if (val === 1) backups.push(name);
        });

        /* ========== 선발 행 ========== */
        const trStarter = document.createElement('tr');
        const tdPos = document.createElement('td');
        tdPos.textContent = pos.label;
        tdPos.rowSpan = 2;
        tdPos.style.background = '#bae4ff';
        tdPos.style.fontWeight = 'bolder';

        trStarter.appendChild(tdPos);

        const tdStarterLabel = document.createElement('td');
        tdStarterLabel.textContent = '선발';
        tdStarterLabel.style.background = '#bae4ff';
        tdStarterLabel.style.fontWeight = 'bolder';
        trStarter.appendChild(tdStarterLabel);

        starters.forEach(name => {
          const td = document.createElement('td');
          td.textContent = nameWithNum(name);
          td.onclick = () => onAbilityClick(name, pos.key);

          const assigned = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);
          if (assigned) {
            if (isSamePosition(pos.key, assigned))
              td.classList.add("position-selected");
            else
              td.classList.add("position-locked");
          }
          trStarter.appendChild(td);
        });

        /* ========== 후보 행 ========== */
        const trBackup = document.createElement('tr');
        const tdBackupLabel = document.createElement('td');
        tdBackupLabel.textContent = '후보';
        tdBackupLabel.style.background = '#ffbbbb';
        tdBackupLabel.style.fontWeight = 'bolder';
        trBackup.appendChild(tdBackupLabel);

        backups.forEach(name => {
          const td = document.createElement('td');
          td.textContent = nameWithNum(name);
          td.onclick = () => onAbilityClick(name, pos.key);

          const assigned = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);
          if (assigned) {
            if (isSamePosition(pos.key, assigned))
              td.classList.add("position-selected");
            else
              td.classList.add("position-locked");
          }
          trBackup.appendChild(td);
        });

        table.appendChild(trStarter);
        table.appendChild(trBackup);
      });

      container.appendChild(table);
    }

    function isSamePosition(posKey, assigned) {
      if (!assigned) return false;

      const a = assigned.toLowerCase();

      if (posKey === 'of') {
        return ['cf', 'lf', 'rf'].includes(a);
      }

      return posKey.toLowerCase() === a;
    }

    function convertPosition(code) {
      const map = {
        CF: '중견수(CF)',
        LF: '좌익수(LF)',
        RF: '우익수(RF)',
        SS: '유격수(SS)',
        '2B': '2루수(2B)',
        '3B': '3루수(3B)',
        '1B': '1루수(1B)',
        P: '투수(P)',
        C: '포수(C)',
        DH: '지명타자(DH)'
      };
      return map[code] || '';
    }

    /* ===============================
       외야 포지션 팝업 처리
    =============================== */

    let pendingOutfieldPlayer = null;

    function onAbilityClick(name, posKey) {
      if (posKey === 'of') {
        pendingOutfieldPlayer = name;
        document.getElementById("outfieldPopup").style.display = "block";
        return;
      }

      const posMap = {
        p: 'P', c: 'C',
        '1b': '1B', '2b': '2B', '3b': '3B',
        ss: 'SS'
      };

      const posCode = posMap[posKey];
      updatePosition(posCode, name);
      refreshAll();
    }

    function selectOutfieldPosition(posCode) {
      if (!pendingOutfieldPlayer) return;

      updatePosition(posCode, pendingOutfieldPlayer);

      pendingOutfieldPlayer = null;
      closeOutfieldPopup();
      refreshAll();
    }

    function closeOutfieldPopup() {
      document.getElementById("outfieldPopup").style.display = "none";
    }

    /* ===============================
       전체 렌더링
    =============================== */

    function refreshAll() {
      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    /* ===============================
       저장
    =============================== */

    async function saveOrder() {
      const name = document.getElementById('orderName').value.trim();
      if (!name) return alert("오더명을 입력하세요.");

      const pw = prompt("비밀번호를 입력하세요");
      if (!pw) return;

      const valid = await fetch("https://checkpassword-2guymqucma-uc.a.run.app", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pw })
      }).then(r => r.json());

      if (valid.status !== "성공") {
        alert("비밀번호 오류");
        return;
      }

      const exists = await fetch(
        "https://orderexists-2guymqucma-uc.a.run.app?name=" + encodeURIComponent(name)
      ).then(r => r.json());

      if (exists.exists) {
        if (!confirm("이미 존재하는 오더입니다. 덮어쓸까요?")) return;
      }

      const payload = {
        players: selectedPlayers.map(name => {
          const p = playerDB.find(x => x.name === name);
          return { name, num: p.num };
        }),

        positions: { ...positionAssignments },
        startingList: startingList.map(r => ({
          name: r.name,
          pos: r.pos
        })),

      };

      const res = await fetch("https://saveorder-2guymqucma-uc.a.run.app", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderName: name, payload })
      }).then(r => r.json());

      if (res.status === "성공") {
        alert("저장되었습니다!");
        location.href = "index.html";
      } else {
        alert("저장 실패: " + res.error);
      }
    }

    /* ===============================
       초기화
    =============================== */

    window.onload = async () => {
      await loadPlayerDB();
      setupStartingTable();
      refreshAll();

      const orderName = new URLSearchParams(window.location.search).get("orderName");
      if (!orderName) return;

      document.getElementById('orderName').value = orderName;

      const data = await fetch(
        "https://getorder-2guymqucma-uc.a.run.app?name=" + encodeURIComponent(orderName)
      ).then(r => r.json());

      if (!data || !data.payload) {
        alert("오더 불러오기 실패");
        return;
      }

      selectedPlayers = data.payload.players.map(p => p.name);
      positionAssignments = { ...positionAssignments, ...data.payload.positions };
      startingList = [...data.payload.startingList];

      refreshAll();
    };
  </script>

  <!-- 외야 선택 팝업 -->
  <div id="outfieldPopup" style="
       display:none;
       position:fixed;
       top:50%;
       left:50%;
       transform:translate(-50%, -50%);
       background:white;
       border:2px solid #333;
       padding:20px;
       border-radius:10px;
       z-index:1000;
       text-align:center;">
    <h3>외야 포지션 선택</h3>
    <button class="buttonStyles" onclick="selectOutfieldPosition('LF')">좌익수(LF)</button>
    <button class="buttonStyles" onclick="selectOutfieldPosition('CF')">중견수(CF)</button>
    <button class="buttonStyles" onclick="selectOutfieldPosition('RF')">우익수(RF)</button>
    <br><br>
    <button class="buttonStyles" onclick="closeOutfieldPopup()">취소</button>
  </div>

</body>

</html>