<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>삼성 헌터스 오더 관리 시스템</title>

  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <h1>⚾ 삼성 헌터스 오더 관리 시스템 ⚾</h1>

  <div class="adminButtonBox">
    <button class="buttonStyles" onclick="location.href='order_write.html'">오더 작성</button>
    <button class="buttonStyles" onclick="location.href='admin.html'">선수 관리</button>
    <button class="buttonStyles" onclick="changePassword()">관리자</button>
  </div>

  <div id="orderViewPanel">

    <div id="orderViewHeader">
      <span id="selectedOrderName">오더를 선택하세요</span>

      <div id="viewButtons">
        <button class="buttonStyles" id="captureBtn">캡처</button>
        <button class="buttonStyles" id="editBtn">수정</button>
      </div>
    </div>

    <hr>

    <div id="orderDetailWrapper">

      <!-- 필드 -->
      <div id="fieldArea">
        <div id="positionWrapper">
          <div id="areaB">
            <div id="areaB1">
              <div class="posBox" id="pos_P"></div>
              <div class="posBox" id="pos_C"></div>
              <div class="posBox" id="pos_1B"></div>
              <div class="posBox" id="pos_2B"></div>
              <div class="posBox" id="pos_3B"></div>
              <div class="posBox" id="pos_SS"></div>
              <div class="posBox" id="pos_LF"></div>
              <div class="posBox" id="pos_CF"></div>
              <div class="posBox" id="pos_RF"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 선발 -->
      <div id="startingArea">
        <label style="font-weight: bolder;">선발 명단</label>
        <table id="startingTable" class="table_common">
          <thead>
            <tr>
              <th style="width: 20px;">타순</th>
              <th style="width: 80px;">선수명</th>
              <th style="width: 100px;">포지션</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 대기 -->
      <div id="waitingArea">
        <label style="font-weight: bolder;">대기 명단</label>
        <table id="waitingTable" class="table_common">
          <thead>
            <tr>
              <th style="width: 80px;">선수명</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <hr>

    <!-- 오더 리스트 -->
    <div id="orderListBottom">
      <h3>오더 리스트</h3>
      <table id="orderTable" class="table_common">
        <thead>
          <tr>
            <th style="width: 760px; text-align: left;">오더명</th>
            <th style="width: 100px;">저장일자</th>
            <th style="width: 40px;">삭제</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>

    const API = {
      getOrders: "https://getorders-2guymqucma-uc.a.run.app",
      getOrder: "https://getorder-2guymqucma-uc.a.run.app",
      deleteOrder: "https://us-central1-hunters-f2581.cloudfunctions.net/deleteOrder",
      check: "https://checkpassword-2guymqucma-uc.a.run.app",
      updatePw: "https://updatepassword-2guymqucma-uc.a.run.app"
    };

    let currentOrderName = null;

    /* 날짜 포맷 */
    function formatDate(dateString) {
      const d = new Date(dateString);
      return `${String(d.getFullYear()).slice(2)}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")} ${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
    }

    /* 이름(배번) */
    function nameWithNum(name, players) {
      const p = players.find(x => x.name === name);
      return p ? `${name}(${p.num})` : name;
    }

    window.onload = () => loadOrderList();

    /* 리스트 로딩 */
    async function loadOrderList() {
      const tbody = document.querySelector("#orderTable tbody");
      tbody.innerHTML = "";

      const list = await fetch(API.getOrders).then(r => r.json());

      list.forEach(item => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = item.orderName;
        nameTd.onclick = () => loadOrderView(item.orderName);
        nameTd.style.textAlign = "left";

        const dateTd = document.createElement("td");
        dateTd.textContent = formatDate(item.savedAt);

        const delTd = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "삭제";
        delBtn.className = "buttonStyles";
        delBtn.onclick = () => deleteOrderWithPW(item.orderName);
        delTd.appendChild(delBtn);

        tr.appendChild(nameTd);
        tr.appendChild(dateTd);
        tr.appendChild(delTd);
        tbody.appendChild(tr);
      });
    }

    /* 상세 보기 */
    async function loadOrderView(name) {
      currentOrderName = name;
      document.getElementById("selectedOrderName").textContent = name;

      const data = await fetch(API.getOrder + "?name=" + encodeURIComponent(name))
        .then(r => r.json());

      if (!data || !data.payload) {
        alert("오더 데이터가 손상되었거나 존재하지 않습니다.");
        return;
      }

      const payload = data.payload;
      window._currentPlayers = payload.players;
      renderPositions(payload.positions);
      renderStarting(payload.startingList, payload.players);
      renderWaiting(payload.players, payload.startingList);
    }

    /* 포지션 출력 */
    function renderPositions(pos) {
      ["P", "C", "1B", "2B", "3B", "SS", "LF", "CF", "RF"].forEach(key => {
        const box = document.getElementById("pos_" + key);
        const name = pos[key];
        box.textContent = name ? nameWithNum(name, window._currentPlayers) : "";

      });
    }

    /* 선발 */
    function renderStarting(list, players) {
      const tbody = document.querySelector("#startingTable tbody");
      tbody.innerHTML = "";

      list.forEach((item, idx) => {
        const tr = document.createElement("tr");
        const orderLabel = idx === 9 ? "투수" : (idx + 1);

        tr.innerHTML = `
          <td>${orderLabel}</td>
          <td>${item.name ? nameWithNum(item.name, players) : ""}</td>
          <td>${item.pos || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* 대기 명단 */
    function renderWaiting(players, startingList) {
      const tbody = document.querySelector("#waitingTable tbody");
      tbody.innerHTML = "";

      const usedNames = startingList
        .map(s => s.name)
        .filter(Boolean);

      const waitingNames = players
        .map(p => p.name)
        .filter(n => !usedNames.includes(n));

      waitingNames.forEach(name => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${nameWithNum(name, players)}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* 수정 */
    document.getElementById("editBtn").onclick = () => {
      if (!currentOrderName) return alert("오더를 선택하세요");
      location.href = "order_write.html?orderName=" + encodeURIComponent(currentOrderName);
    };

    /* 삭제 */
    async function deleteOrderWithPW(name) {
      const pw = prompt("삭제 비밀번호 입력");
      if (!pw) return;

      const valid = await fetch(API.check, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pw })
      }).then(r => r.json());

      if (valid.status !== "성공") return alert("비밀번호 오류!");

      const res = await fetch(API.deleteOrder + "?name=" + encodeURIComponent(name))
        .then(r => r.json());

      if (res.status === "deleted") {
        alert("삭제되었습니다.");
      } else {
        alert("삭제 처리 중 오류 발생.");
      }

      loadOrderList();
      document.querySelector("#startingTable tbody").innerHTML = "";
      document.querySelector("#waitingTable tbody").innerHTML = "";
      document.getElementById("selectedOrderName").textContent = "오더를 선택하세요";
    }

    /* 캡처 */
    document.getElementById("captureBtn").onclick = () => {
      alert("캡처 기능은 추후 추가됩니다.");
    };

    /* 비밀번호 변경 */
    async function changePassword() {
      const oldPw = prompt("현재 비밀번호 입력");
      if (!oldPw) return;

      const checkRes = await fetch(API.check, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: oldPw })
      }).then(r => r.json());

      if (checkRes.status !== "성공") {
        alert("비밀번호 오류");
        return;
      }

      const newPw = prompt("새 비밀번호 입력");
      if (!newPw) return;

      const upd = await fetch(API.updatePw, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ oldPassword: oldPw, newPassword: newPw })
      }).then(r => r.json());

      if (upd.status === "성공") alert("변경 완료!");
      else alert("변경 실패: " + upd.error);
    }

  </script>

</body>

</html>