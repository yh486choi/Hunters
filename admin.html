<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì„ ìˆ˜ ê´€ë¦¬ âš¾</title>

  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="admin.css" />
  <script>
    /* í˜ì´ì§€ ë¡œë“œ ì „ í…Œë§ˆ ì¦‰ì‹œ ì ìš© (ê¹œë¹¡ì„ ë°©ì§€) */
    (function () {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>

<body>
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
  </div>

  <h1>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì„ ìˆ˜ ê´€ë¦¬ âš¾</h1>
  <hr>
  <div style='margin-top:10px; display:flex; gap:10px;'>
    <button class="buttonStyles" onclick="goMain()">ğŸ  í™ˆí™”ë©´</button>
    <button class="buttonStyles" onclick="toggleDarkMode()">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
    <button class="buttonStyles" onclick="saveAll()">ğŸ’¾ ì €ì¥</button>
    <button class="buttonStyles" onclick="loadPlayers()">â†© ì›ë˜ëŒ€ë¡œ</button>
  </div>

  <div class="controls" style="margin-bottom: 10px;">
    <span class="new-player-title">ì‹ ê·œ ì„ ìˆ˜ ì¶”ê°€</span>
  </div>

  <table class="table_common table_admin_add">
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ë°°ë²ˆ</th>
        <th>íˆ¬ìˆ˜</th>
        <th>í¬ìˆ˜</th>
        <th>1ë£¨ìˆ˜</th>
        <th>2ë£¨ìˆ˜</th>
        <th>3ë£¨ìˆ˜</th>
        <th>ìœ ê²©ìˆ˜</th>
        <th>ì™¸ì•¼ìˆ˜</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr id="addRow">
        <td style="width: 70px;"><input style="width: 50px;" type="text" id="add_name" /></td>
        <td style="width: 70px;"><input style="width: 40px;" type="number" id="add_num" min="0" max="99" /></td>
        <td style="width: 80px;"><select id="add_p"></select></td>
        <td style="width: 80px;"><select id="add_c"></select></td>
        <td style="width: 80px;"><select id="add_1b"></select></td>
        <td style="width: 80px;"><select id="add_2b"></select></td>
        <td style="width: 80px;"><select id="add_3b"></select></td>
        <td style="width: 80px;"><select id="add_ss"></select></td>
        <td style="width: 80px;"><select id="add_of"></select></td>
        <td style="width: 40px"><button class="buttonStyles" onclick="addNewPlayer()">ì¶”ê°€</button></td>
      </tr>
    </tbody>
  </table>

  <div class="controls" style="margin-bottom: 10px;">
    <span>ì„ ìˆ˜ëª©ë¡</span>
  </div>

  <table id="playerTable" class="table_common table_admin_list">
    <thead>
      <tr>
        <th>ì´ë¦„ <button onclick="setSort('name')">â‡…</button></th>
        <th>ë°°ë²ˆ <button onclick="setSort('num')">â‡…</button></th>
        <th>íˆ¬ìˆ˜ <button onclick="setSort('p')">â‡…</button></th>
        <th>í¬ìˆ˜ <button onclick="setSort('c')">â‡…</button></th>
        <th>1ë£¨ìˆ˜ <button onclick="setSort('1b')">â‡…</button></th>
        <th>2ë£¨ìˆ˜ <button onclick="setSort('2b')">â‡…</button></th>
        <th>3ë£¨ìˆ˜ <button onclick="setSort('3b')">â‡…</button></th>
        <th>ìœ ê²©ìˆ˜ <button onclick="setSort('ss')">â‡…</button></th>
        <th>ì™¸ì•¼ìˆ˜ <button onclick="setSort('of')">â‡…</button></th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API = {
      check: "https://checkpassword-2guymqucma-uc.a.run.app",
      getPlayers: "https://getplayers-2guymqucma-uc.a.run.app",
      updatePlayers: "https://updateplayers-2guymqucma-uc.a.run.app"
    };

    function showLoading(text = "ì²˜ë¦¬ ì¤‘...") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").style.display = "flex";
    }

    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    function applySavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') document.body.classList.add('dark-mode');
    }

    function toggleDarkMode() {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    const POS_FIELDS = ["p", "c", "1b", "2b", "3b", "ss", "of"];
    let currentSortField = "name";
    let currentSortOrder = "asc";
    const LABELS = { "0": "ğŸ”´ ë¶ˆ", "1": "ğŸŸ¡ ë¶€", "2": "ğŸŸ¢ ì£¼" };

    function goMain() { window.location.href = "index.html"; }

    function initAddSelects() {
      POS_FIELDS.forEach(pos => {
        const sel = document.getElementById(`add_${pos}`);
        sel.innerHTML = "";
        ["0", "1", "2"].forEach(v => {
          const opt = document.createElement("option");
          opt.value = v; opt.textContent = LABELS[v];
          sel.appendChild(opt);
        });
        sel.value = "0";
      });
    }

    async function loadPlayers() {
      showLoading("ì„ ìˆ˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      try {
        const data = await fetch(API.getPlayers).then(r => r.json());
        renderPlayerTable(sortData(data));
        addModificationListeners();
      } catch (e) {
        alert("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
      } finally {
        hideLoading();
      }
    }

    /* ì‚­ì œ í™•ì¸ ë¡œì§ ì¶”ê°€ */
    function confirmDeleteRow(button) {
      const tr = button.parentElement.parentElement;
      const name = tr.querySelector("td:first-child input").value;
      if (confirm(`'${name}' ì„ ìˆ˜ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìµœì¢… ì €ì¥ì„ ëˆŒëŸ¬ì•¼ ì„œë²„ì— ë°˜ì˜ë©ë‹ˆë‹¤.)`)) {
        tr.remove();
      }
    }

    function renderPlayerTable(data) {
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";
      data.forEach(player => {
        const tr = document.createElement("tr");
        if (player.isModified) tr.classList.add("modified");
        tr.innerHTML = `<td style="width:70px"><input type="text" value="${player.name}" style="width:50px"></td>
                        <td style="width:70px"><input type="number" value="${player.num}" style="width:40px"></td>`;
        POS_FIELDS.forEach(f => {
          const cur = player[f] || "0";
          let html = `<td style="width:80px"><select>`;
          ["0", "1", "2"].forEach(v => { html += `<option value="${v}" ${v === cur ? "selected" : ""}>${LABELS[v]}</option>`; });
          html += `</select></td>`;
          tr.innerHTML += html;
        });
        // ì‚­ì œ í•¨ìˆ˜ êµì²´: confirmDeleteRow í˜¸ì¶œ
        tr.innerHTML += `<td style="width:40px"><button class="buttonStyles" onclick="confirmDeleteRow(this)">ì‚­ì œ</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function sortData(list) {
      return list.sort((a, b) => {
        const A = a[currentSortField] ?? "";
        const B = b[currentSortField] ?? "";
        if (currentSortField === "num") return currentSortOrder === "asc" ? Number(A) - Number(B) : Number(B) - Number(A);
        return currentSortOrder === "asc" ? String(A).localeCompare(String(B), "ko") : String(B).localeCompare(String(A), "ko");
      });
    }

    function setSort(field) {
      if (currentSortField === field) currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
      else { currentSortField = field; currentSortOrder = "asc"; }
      const rows = Array.from(document.querySelectorAll("#playerTable tbody tr")).map(tr => {
        const tds = tr.querySelectorAll("td");
        const obj = { name: tds[0].querySelector("input").value, num: tds[1].querySelector("input").value, isModified: tr.classList.contains("modified") };
        POS_FIELDS.forEach((pos, idx) => { obj[pos] = tds[idx + 2].querySelector("select").value; });
        return obj;
      });
      renderPlayerTable(sortData(rows));
      addModificationListeners();
    }

    function addModificationListeners() {
      document.querySelectorAll("#playerTable tbody tr input, #playerTable tbody tr select").forEach(el => {
        el.addEventListener("change", () => el.closest("tr").classList.add("modified"));
      });
    }

    function addNewPlayer() {
      const name = document.getElementById("add_name").value.trim();
      const num = document.getElementById("add_num").value.trim();
      if (!name || !num) return alert("ì´ë¦„ê³¼ ë°°ë²ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      const rows = Array.from(document.querySelectorAll("#playerTable tbody tr")).map(tr => {
        const tds = tr.querySelectorAll("td");
        const obj = { name: tds[0].querySelector("input").value, num: tds[1].querySelector("input").value, isModified: tr.classList.contains("modified") };
        POS_FIELDS.forEach((pos, idx) => { obj[pos] = tds[idx + 2].querySelector("select").value; });
        return obj;
      });
      const newP = { name, num, isModified: true };
      POS_FIELDS.forEach(f => newP[f] = document.getElementById(`add_${f}`).value);
      rows.push(newP);
      renderPlayerTable(sortData(rows));
      addModificationListeners();
      document.getElementById("add_name").value = ""; document.getElementById("add_num").value = "";
    }

    async function saveAll() {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (!pw) return;

      showLoading("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘...");
      try {
        const check = await fetch(API.check, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pw })
        }).then(r => r.json());

        if (check.status !== "ì„±ê³µ") {
          hideLoading();
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        showLoading("ì„ ìˆ˜ ë°ì´í„°ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");
        const list = Array.from(document.querySelectorAll("#playerTable tbody tr")).map(tr => {
          const tds = tr.querySelectorAll("td");
          const obj = { name: tds[0].querySelector("input").value.trim(), num: tds[1].querySelector("input").value.trim() };
          POS_FIELDS.forEach((f, idx) => { obj[f] = tds[idx + 2].querySelector("select").value; });
          return obj;
        });

        const names = list.map(p => p.name);
        if (new Set(names).size !== names.length) {
          hideLoading();
          return alert("ì„ ìˆ˜ ì´ë¦„ì´ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        const res = await fetch(API.updatePlayers, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(list)
        }).then(r => r.json());

        if (res.status === "ì„±ê³µ") {
          alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          await loadPlayers();
        } else {
          alert("ì €ì¥ ì‹¤íŒ¨: " + res.error);
        }
      } catch (e) {
        alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
      } finally {
        hideLoading();
      }
    }

    initAddSelects(); applySavedTheme(); loadPlayers();
  </script>
</body>

</html>